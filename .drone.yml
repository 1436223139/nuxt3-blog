kind: pipeline
type: docker
name: build

trigger:
  event:
    - push
  branch:
    - master

platform:
  os: linux
  arch: amd64

steps:
  - name: build_project
    image: node:18
    volumes:
      - name: cache
        path: /drone/src/node_modules
      - name: dist
        path: /drone/src/.output
    environment:
      MONGODB_URI:
        from_secret: MONGODB_URI
      CommentRepoId:
        from_secret: CommentRepoId
      CommentDiscussionCategoryId:
        from_secret: CommentDiscussionCategoryId
      CloudflareAnalyze:
        from_secret: CloudflareAnalyze
    commands:
      - npm i -g pnpm
      - pnpm i
      - pnpm build
      - echo "export MONGODB_URI=$MONGODB_URI" > .output/.env

volumes:
  - name: cache
    host:
      path: /var/cache/drone-nuxt3-blog
  - name: dist
    host:
      path: /var/lib/nuxt3-blog

---

kind: pipeline
type: exec
name: reload

trigger:
  event:
    - push
  branch:
    - master

clone:
  disable: true

steps:
  - name: reload_systemd
    commands:
      - whoami
      - journalctl -u nuxt3-blog -n 50
      - systemctl restart nuxt3-blog
depends_on:
  - build